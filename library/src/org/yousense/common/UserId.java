package org.yousense.common;

import android.content.Context;
import android.content.SharedPreferences;
import android.provider.Settings;
import org.apache.commons.codec.binary.Hex;

import java.security.SecureRandom;

/**
 * Users are identified by ANDROID_ID + randomly generated bytes.
 */
public class UserId {
    public static final String PREFS_FILE = "identity";
    public static final String USER_ID = "userid";
    private static final int USER_ID_RANDOM_HEX_LENGTH = 16;

    private static String cachedId;

    public static synchronized String userId(Context context) {
        if (cachedId == null) {
            cachedId = readStoredUserId(context);
            if (cachedId == null) {
                cachedId = writeRandomUserId(context);
            }
        }
        return cachedId;
    }

    private static synchronized String readStoredUserId(Context context) {
        SharedPreferences prefs = context.getSharedPreferences(PREFS_FILE, 0);
        return prefs.getString(USER_ID, null);
    }

    private static synchronized String writeRandomUserId(Context context) {
        byte[] random = new byte[USER_ID_RANDOM_HEX_LENGTH / 2];
        new SecureRandom().nextBytes(random);

        String newId = (androidId(context) + Hex.encodeHex(random)).toLowerCase();

        SharedPreferences prefs = context.getSharedPreferences(PREFS_FILE, 0);
        SharedPreferences.Editor editor = prefs.edit();
        editor.putString(USER_ID, newId);
        editor.commit();
        return newId;
    }

    private static synchronized String androidId(Context context) {
        String aid = Settings.Secure.getString(context.getContentResolver(), Settings.Secure.ANDROID_ID);
        // Known duplicate ID: http://code.google.com/p/android/issues/detail?id=10603
        if (aid == null || "9774d56d682e549c".equals(aid)) {
            return "0000000000000000";
        } else {
            return aid.toLowerCase();
        }
    }

}
